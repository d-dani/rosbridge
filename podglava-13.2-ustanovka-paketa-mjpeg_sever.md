# Подглава 13.2 Установка пакета mjpeg\_sever

Мы будем использовать пакет mjpeg\_server для потоковой передачи живого видео из ROS топика через HTTP в графический интерфейс нашего браузера. Установите его сейчас с помощью следующей команды: 

`$ sudo apt-get install ros-indigo-mjpeg-server`

Чтобы проверить сервер, сначала подключитесь к камере. Для Kinect или Asus Xtion Pro запустите узел OpenNI: 

`$ roslaunch rbx2_vision openni_node.launch`

Если вы используете веб-камеру и предполагаете, что у вас установлен драйвер uvc\_cam из тома 1, вы можете использовать: 

`$ roslaunch rbx2_vision uvc_cam.launch`

Теперь откройте другой терминал и запустите узел mjpeg\_server: 

`$ rosrun mjpeg_server mjpeg_server`

Вы должны увидеть следующие сообщения при запуске: 

`[ INFO] [1382792594.998250777]: Starting mjpeg server   
[ INFO] [1382792594.998890964]: Bind(8080) succeeded   
[ INFO] [1382792594.999053552]: waiting for clients to connect` 

Обратите внимание, что по умолчанию mjpeg\_server использует порт 8080. Если вы уже используете этот порт для чего-то другого, вы можете запустить mjpeg\_server с другим параметром порта. В следующем примере используется порт 8181: 

`$ rosrun mjpeg_server mjpeg_server _port:=8181`

ПРИМЕЧАНИЕ. Когда вы запускаете mjpeg\_server с другим портом, как показано выше, номер порта сохраняется на сервере параметров ROS. Поэтому, если вы запустите mjpeg\_server в более позднем сеансе без параметра порта, он выберет номер порта с сервера параметров вместо порта по умолчанию 8080. Чтобы переопределить значение на сервере параметров, вы можете указать порт по умолчанию в командной строке так же, как мы делали выше с альтернативным портом. Вы также можете использовать включенный файл запуска mjpeg\_server, который устанавливает для параметра порта значение по умолчанию 8080: 

`$ roslaunch rbx2_gui mjpeg_server.launch`

Если вам нужно запустить mjpeg\_server на другом порту, вы можете отредактировать этот файл или сделать его копию и соответственно настроить порт. 

Теперь, когда запущены узел камеры и mjpeg\_server, вы сможете просматривать изображение с камеры по следующему URL-адресу: 

`http://localhost:PORT/stream?topic=/IMAGE_TOPIC` 

где PORT - это порт, на котором мы запускаем mjpeg\_server, а IMAGE\_TOPIC - это топик изображения с камеры, которую мы хотим просмотреть. Используя порт 8080 по умолчанию и изображение topic/camera/rgb/ mage\_color, используемое как файлом openni\_node.launch, так и файлом uvc\_cam.launch, мы будем использовать URL:  

`http://localhost:8080/stream?topict=/camera/RGB/image_color` 

ВАЖНОЕ ПРИМЕЧАНИЕ. До недавнего времени этот URL можно было вводить прямо в браузере для просмотра потокового видео. Однако последние изменения в стандартах веб-браузера требуют, чтобы потоки mjpeg теперь были встроены в стандартную веб-страницу. 

Например, если вы введете вышеуказанный URL в последнюю версию Google Chrome под Ubuntu 12.04, вы просто получите пустую страницу. Временное решение: создать минимальную веб-страницу с тегом &lt;img&gt;, указывающим на нужный URL-адрес. Например, следующая веб-страница будет работать с указанным выше URL: 

```text
<html>
    <head>
        <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
        <title>mjpeg_server</title>
    </head>
    <body>
        <img src="
http://localhost:8080/stream?topic=/camera/rgb/image_color
">
    </body>
</html>
```

Этот пример можно найти в каталоге rbx2\_gui и называется mjpeg\_server.html. Откройте этот файл в своем веб-браузере \(щелкните меню «Файл», выберите «Открыть файл», затем перейдите к файлу в каталоге rbx2\_gui\), и вы увидите потоковое видео. 

Если что вы можете видеть живое потоковое изображение, вы можете также изменить разрешение изображения на лету, используя rqt\_reconfigure: 

`$ rosrun rqt_reconfigure rqt_reconfigure`

Выберите драйвер камеры в окне перенастройки и измените режим изображения с QVGA\_30Hz \(5\) на VGA\_30Hz \(2\). В своем веб-браузере вы должны увидеть, как изображение сразу же изменит размер с 320x240 пикселей до 640x480. 

Если вы подключены к Kinect или Xtion Pro с помощью файла openn\_node.launch, вы можете просмотреть изображение в градациях серого, используя URL: 

`http://localhost:8080/stream?topic=/camera/rgb/image_mono` 

в вашем HTML-файле. 

Несмотря на то, что в топике /camera/depth/image\_rect опубликовано изображение глубины, которое можно просмотреть в image\_view, оно не будет отображаться с использованием mjpeg\_server на момент написания этой статьи. Запрос на улучшение был отправлен на страницу GitHub mjpeg\_server. 

Наконец, есть четыре других параметра потокового изображения: 

* ширина \(целое число, по умолчанию: исходная ширина\). Размер изображения будет изменен на новую ширину и высоту. Этот параметр должен использоваться вместе с параметром высоты. 
* высота \(целое число, по умолчанию: исходная высота\). Размер изображения будет изменен на новую ширину и высоту. Этот параметр должен использоваться вместе с параметром высоты. 
* качество \(целое число, по умолчанию: 90\). Качество изображения JPEG \(1-100\). Этот параметр можно использовать для уменьшения размера результирующего потока mjpeg. 
* инвертировать \(нет, по умолчанию: \). Поворачивает изображение на 180 градусов перед потоковой передачей 

Для просмотра цветного изображения размером 1280x960 \(независимо от исходного разрешения\) и качеством JPEG в размере 50 используйте URL-адрес: 

`http://localhost:8080/stream?topic=/camera/rgb/image_color?width=1280?height=960?quality=50` 

Использование более низкого качества может быть полезно для уменьшения пропускной способности, необходимой для видеопотока. 

